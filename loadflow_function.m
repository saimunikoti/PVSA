
function [V] = loadflow_function(S)

    V_in=2.7713; 
    t=1; 
    f=1;
    g=1/5280; % ft to mile

    %% line impedance

    z721 = [ 0.2926+1j*0.1973   0.0673-1j*0.0368   0.0337-1j*0.0417
             0.0673-1j*0.0368   0.2646+1j*0.1900   0.0673-1j*0.0368
             0.0337-1j*0.0417   0.0673-1j*0.0368   0.2926+1j*0.1973 ];% ohm per mile

    z722 = [ 0.4751+1j*0.2973   0.1629-1j*0.0326   0.1234-1j*0.0607
             0.1629-1j*0.0326   0.4488+1j*0.2678   0.1629-1j*0.0326
             0.1234-1j*0.0607   0.1629-1j*0.0326   0.4751+1j*0.2973 ];% ohm per mile

    z723 = [ 1.2936+1j*0.6713   0.4871+1j*0.2111   0.4585+1j*0.1521
             0.4871+1j*0.2111   1.3022+1j*0.6326   0.4871+1j*0.2111
             0.4585+1j*0.1521   0.4871+1j*0.2111   1.2936+1j*0.6713 ];% ohm per mile

    z724 = [ 2.0952+1j*0.7758   0.5204+1j*0.2738   0.4926+1j*0.2123
             0.5204+1j*0.2738   2.1068+1j*0.7398   0.5204+1j*0.2738
             0.4926+1j*0.2123   0.5204+1j*0.2738   2.0952+1j*0.7758 ];% ohm per mile

    for k=1:37
        V(k,:,1)=V_in*[1+0i -0.5-0.866i -0.5+0.866i];
    end
    to = tic;
    while(f)
        for k=1:37
            I(k,1,t)=conj((S(k,1)+S(k,2)*1i)/V(k,1,t));
            I(k,2,t)=conj((S(k,3)+S(k,4)*1i)/V(k,2,t));
            I(k,3,t)=conj((S(k,5)+S(k,6)*1i)/V(k,3,t));
        end
        I20_21=I(21,:,t);
        I20_22=I(22,:,t);
        I19_20=I(20,:,t)+I20_21+I20_22;
        I18_19=I(19,:,t)+I19_20;
        I14_18=I(18,:,t)+I18_19;
        I15_16=I(16,:,t);
        I15_17=I(17,:,t);
        I14_15=I(15,:,t)+I15_16+I15_17;
        I13_14=I(14,:,t)+I14_15+I14_18;
        I11_13=I(13,:,t)+I13_14;
        I11_12=I(12,:,t);
        I10_11=I(11,:,t)+I11_12+I11_13;
        I10_24=I(24,:,t);
        I10_23=I(23,:,t);
        I9_10=I(10,:,t)+I10_11+I10_23+I10_24;
        I4_9=I(9,:,t)+I9_10;
        I6_8=I(8,:,t);
        I6_7=I(7,:,t);
        I5_6=I(6,:,t)+I6_7+I6_8;
        I4_5=I(5,:,t)+I5_6;
        I3_4=I(4,:,t)+I4_5+I4_9;
        I25_27=I(27,:,t);
        I25_26=I(26,:,t);
        I3_25=I(25,:,t)+I25_26+I25_27;
        I33_34=I(34,:,t);
        I32_33=I(33,:,t)+I33_34;
        I35_37=I(37,:,t);
        I35_36=I(36,:,t);
        I32_35=I(35,:,t)+I35_37+I35_36;
        I29_32=I(32,:,t)+I32_35+I32_33;
        I30_31=I(31,:,t);
        I29_30=I(30,:,t)+I30_31;
        I28_29=I(29,:,t)+I29_30+I29_32;
        I3_28=I(28,:,t)+I28_29;
        I2_3=I(3,:,t)+I3_25+I3_28+I3_4;
        I1_2=I(2,:,t)+I2_3;

        % updating voltages
        V(1,:,t+1)=V(1,:,t);
        V(2,:,t+1)=V(1,:,t+1)-0.001*(1000*g*z721*I1_2')'; %length changed from 1850
        V(3,:,t+1)=V(2,:,t+1)-0.001*(960*g*z722*I2_3')';
        V(25,:,t+1)=V(3,:,t+1)-0.001*(400*g*z724*I3_25')';
        V(26,:,t+1)=V(25,:,t+1)-0.001*(240*g*z724*I25_26')';
        V(27,:,t+1)=V(25,:,t+1)-0.001*(320*g*z724*I25_27')';
        V(28,:,t+1)=V(3,:,t+1)-0.001*(360*g*z723*I3_28')';
        V(29,:,t+1)=V(28,:,t+1)-0.001*(520*g*z723*I28_29')';
        V(30,:,t+1)=V(29,:,t+1)-0.001*(80*g*z724*I29_30')';
        V(31,:,t+1)=V(30,:,t+1)-0.001*(520*g*z724*I30_31')';
        V(32,:,t+1)=V(29,:,t+1)-0.001*(800*g*z723*I29_32')';
        V(33,:,t+1)=V(32,:,t+1)-0.001*(600*g*z723*I32_33')';
        V(34,:,t+1)=V(33,:,t+1)-0.001*(280*g*z724*I33_34')';
        V(35,:,t+1)=V(32,:,t+1)-0.001*(920*g*z724*I32_35')';
        V(36,:,t+1)=V(35,:,t+1)-0.001*(120*g*z724*I35_36')';
        V(37,:,t+1)=V(35,:,t+1)-0.001*(760*g*z724*I35_37')';
        V(4,:,t+1)=V(3,:,t+1)-0.001*(1320*g*z722*I3_4')';
        V(5,:,t+1)=V(4,:,t+1)-0.001*(240*g*z724*I4_5')';
        V(6,:,t+1)=V(5,:,t+1)-0.001*(280*g*z723*I5_6')';
        V(7,:,t+1)=V(6,:,t+1)-0.001*(200*g*z724*I6_7')';
        V(8,:,t+1)=V(6,:,t+1)-0.001*(280*g*z724*I6_8')';
        V(9,:,t+1)=V(4,:,t+1)-0.001*(600*g*z723*I4_9')';
        V(10,:,t+1)=V(9,:,t+1)-0.001*(200*g*z723*I9_10')';
        V(23,:,t+1)=V(10,:,t+1)-0.001*(600*g*z723*I10_23')';
        V(24,:,t+1)=V(10,:,t+1)-0.001*(0*I10_24')';
        % V(24,:,t+1)=V(10,:,t+1)-0.001*(300*g*z721*I10_24')'; % load is added at 775
        V(11,:,t+1)=V(10,:,t+1)-0.001*(320*g*z723*I10_11')';
        V(12,:,t+1)=V(11,:,t+1)-0.001*(320*g*z724*I11_12')';
        V(13,:,t+1)=V(11,:,t+1)-0.001*(320*g*z723*I11_13')';
        V(14,:,t+1)=V(13,:,t+1)-0.001*(560*g*z723*I13_14')';
        V(15,:,t+1)=V(14,:,t+1)-0.001*(520*g*z724*I14_15')';
        V(16,:,t+1)=V(15,:,t+1)-0.001*(200*g*z724*I15_16')';
        V(17,:,t+1)=V(15,:,t+1)-0.001*(1280*g*z724*I15_17')';
        V(18,:,t+1)=V(14,:,t+1)-0.001*(640*g*z723*I14_18')';
        V(19,:,t+1)=V(18,:,t+1)-0.001*(400*g*z723*I18_19')';
        V(20,:,t+1)=V(19,:,t+1)-0.001*(400*g*z723*I19_20')';
        V(21,:,t+1)=V(20,:,t+1)-0.001*(200*g*z724*I20_21')';
        V(22,:,t+1)=V(20,:,t+1)-0.001*(400*g*z723*I20_22')';

        t=t+1;

        if (abs(V(:,:,t)-V(:,:,t-1))<=0.00001)
            f=0;
        end
        if toc(to)>5 % skip if load flow computation is taking too much time
           f=0; 
        end 
    end
    V= V(:,:,t);
    
